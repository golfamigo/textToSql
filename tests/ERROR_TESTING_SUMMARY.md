# 模型錯誤驗證測試摘要

本文檔說明了針對 TextToSQL 應用程序模型的錯誤情況測試策略和實現。

## 測試結構

錯誤驗證測試分為三個主要文件，每個文件負責測試不同類型的錯誤情況：

1. **test_model_error_validation.py** - 基本錯誤驗證測試
2. **test_advanced_error_validation.py** - 進階錯誤驗證測試  
3. **test_model_boundary_validation.py** - 邊界值和極端情況測試

## 測試覆蓋範圍

測試覆蓋了以下模型：

- **UserModel** - 用戶資訊
- **BookingModel** - 預約資訊
- **ServiceModel** - 服務項目
- **TimePeriodModel** - 時間段
- **BusinessModel** - 商家資訊
- **QueryHistoryModel** - 查詢歷史
- **QueryTemplateModel** - 查詢模板

## 錯誤情況分類

### 1. 基本錯誤驗證

- 必填欄位缺失
- 無效的數據類型
- 無效的枚舉值
- 違反字段邏輯約束 (如結束時間早於開始時間)
- 無效的格式 (如電子郵件、電話號碼)

### 2. 進階錯誤驗證

- JSON 格式錯誤
- 日期時間格式錯誤
- UUID 格式錯誤
- 複雜驗證條件違反
- 嵌套數據驗證錯誤

### 3. 邊界值和極端情況

- 最大/最小數值
- 極短/極長時間間隔
- 時間段邊界 (跨日、整天)
- 枚舉邊界值
- 空值和最小必填項測試
- 混合有效無效欄位
- 級聯錯誤依賴關係
- 嵌套 JSON 結構驗證

## 測試方法

所有測試都遵循相似的模式：

1. 準備測試數據（包括有效和無效資料）
2. 使用 pytest 的 `pytest.raises` 上下文管理器捕獲預期的 ValidationError 異常
3. 檢查錯誤訊息是否包含預期的內容或欄位名稱
4. 對於不應該引發錯誤的邊界情況，使用 try-except 確保沒有錯誤發生

## 關鍵測試案例

### 格式驗證

- 電子郵件格式驗證
- UUID 格式驗證
- 日期時間格式驗證
- JSON 格式驗證

### 業務邏輯驗證

- 時間範圍驗證（結束時間必須晚於開始時間）
- 價格和時間長度不能為負數
- 時間段必須指定星期幾或特定日期

### 邊界值測試

- 價格為零或極大值
- 極短和極長的時間間隔
- 時間段的開始和結束邊界（00:00 - 23:59）
- 枚舉的最小和最大值

### 資料結構驗證

- 嵌套 JSON 結構的驗證
- 包含特殊字符的欄位驗證
- 極長文本欄位的處理

## 測試覆蓋範圍分析

這些測試共覆蓋了 30+ 個錯誤情況，包括：

- 所有模型的必填欄位驗證
- 所有枚舉類型的無效值測試
- 所有日期時間相關欄位的邏輯驗證
- 所有 UUID 欄位的格式驗證
- 所有複雜數據結構（JSON、嵌套）的驗證
- 關鍵業務邏輯的邊界情況測試

## 建議的改進

根據測試結果，我們建議以下改進：

1. 增加對 ServiceModel 的 price 和 duration 欄位的負數驗證
2. 改進 TimePeriodModel 對跨日時間段的處理
3. 考慮對所有字串欄位增加最大長度限制
4. 為 BusinessModel 的 timezone 欄位增加有效時區驗證
5. 考慮為 JSON 欄位添加更嚴格的結構驗證